<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>College of DuPage Lunabotics: Overview</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="style.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="chap.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">College of DuPage Lunabotics
   &#160;<span id="projectnumber">2024</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Overview </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="md__home_grayson_Lunabotics_2024_README"></a> This repository contains code made by the College of DuPage team for the NASA Lunabotics competition. It is made for ROS 2 Humble on Ubuntu 22.04.</p>
<h1><a class="anchor" id="autotoc_md31"></a>
Hardware</h1>
<ul>
<li><code>Intel NUC 13 Pro</code></li>
<li><code>RPLidar S2L</code></li>
<li><code>RPLidar A3</code></li>
<li><code>Intel RealSense D455 Depth Camera</code></li>
<li><code>Intel RealSense T265 Tracking Camera</code></li>
<li><code>CTRE Falcon 500 (x2)</code></li>
<li><code>RoyPow 12V 18Ah LiFePO4 Battery</code></li>
<li><code>Turnigy 14.8V 12000mAh LiPo Battery</code></li>
<li><code>AndyMark Power Distribution Panel</code></li>
<li><code>MKS CANable Pro</code></li>
</ul>
<h1><a class="anchor" id="autotoc_md32"></a>
Dependencies</h1>
<ul>
<li><code>rtabmap</code></li>
<li><code>rtabmap_ros</code></li>
<li><code>rplidar_ros</code></li>
<li><code>apriltag_ros</code></li>
<li><code>navigation2</code></li>
<li><code>robot_localization</code></li>
<li><code>laser_filters</code></li>
<li><code>imu_complementary_filter</code></li>
</ul>
<h1><a class="anchor" id="autotoc_md33"></a>
Installation</h1>
<h3><a class="anchor" id="autotoc_md34"></a>
1. Download the source code for https://github.com/IntelRealSense/librealsense/releases/tag/v2.53.1 and install.</h3>
<p><code>Note: this repository contains realsense-ros version 4.51.1 in external directory. This is because support was dropped for the T265 camera in later releases.</code></p>
<div class="fragment"><div class="line">cd Downloads/</div>
<div class="line">tar -xzvf librealsense-2.53.1.tar.gz</div>
<div class="line">cd librealsense-2.53.1/</div>
<div class="line">mkdir build &amp;&amp; cd build</div>
<div class="line">cmake ../ -DFORCE_RSUSB_BACKEND=false -DCMAKE_BUILD_TYPE=release -DBUILD_EXAMPLES=true -DBUILD_GRAPHICAL_EXAMPLES=true</div>
<div class="line">sudo make uninstall &amp;&amp; make clean &amp;&amp; make -j8 &amp;&amp; sudo make install</div>
<div class="line">cd ..</div>
<div class="line">sudo ./scripts/setup_udev_rules.sh # Make sure cameras are unplugged before running</div>
</div><!-- fragment --><p>The flag -DFORCE_RSUSB_BACKEND=false is meant for kernel 5.15 and below, but the Intel NUC 13 Pro is currently on kernel 6.5 and it has been working well. Whenever I have set -DFORCE_RSUSB_BACKEND=true, librealsense performs poorly and the camera will sometimes fail to start with a "failed to set power state" error.</p>
<h3><a class="anchor" id="autotoc_md35"></a>
2. Next, make a workspace and clone the repository.</h3>
<div class="fragment"><div class="line">mkdir -p lunabot_ws/src</div>
<div class="line">cd lunabot_ws/src</div>
<div class="line">git clone https://github.com/grayson-arendt/Lunabotics-2024.git</div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md36"></a>
3. Run the install_dependencies script to install the required dependencies and build.</h3>
<div class="fragment"><div class="line">cd lunabot_ws/src/Lunabotics-2024/</div>
<div class="line">chmod +x install_dependencies.sh</div>
<div class="line">sudo ./install_dependencies.sh</div>
<div class="line">cd ../..</div>
<div class="line">colcon build</div>
<div class="line">sudo apt --fix-broken install</div>
</div><!-- fragment --><p>The install_dependencies.sh script will also remove librealsense2 and <a class="el" href="namespacerealsense2__camera.html">realsense2_camera</a> packages. I have not been able to find another way around this yet, but RTAB-Map depends on librealsense2 and <a class="el" href="namespacerealsense2__camera.html">realsense2_camera</a> and will cause broken dependencies. However, when the workspace is built, it will choose to use the newest realsense2_ros and not the one in the external directory, which will cause the T265 camera not to work. The current work around is to remove the packages before building the workspace, then fixing the broken dependencies afterwards.</p>
<h3><a class="anchor" id="autotoc_md37"></a>
4. Repeat the last two steps (excluding the last line) with the branch from this link https://github.com/grayson-arendt/Lunabotics-2024/tree/external-dev?tab=readme-ov-file on the host computer (not robot computer). This branch is for visualizing the robot in RViz2.</h3>
<h1><a class="anchor" id="autotoc_md38"></a>
Setup Permissions and CTRE Phoenix Library</h1>
<p>The rplidar_ros package needs to access /dev/ttyUSB0 and /dev/ttyUSB1 (using both lidars). While you can run <code>sudo chmod +x 777 /dev/ttyUSB0</code> for example, it would need to be ran each time on startup. To fix this, run the command below and restart the computer.</p>
<div class="fragment"><div class="line">sudo usermod -a -G dialout $USER</div>
</div><!-- fragment --><p>If the lidars are not under /dev/ttyUSB0 and /dev/ttyUSB1 (which may happen when disconnected and reconnected), use this command with one lidar connected at a time to check the number at the end. Adjust the parameter in <a class="el" href="hardware__launch_8py.html">hardware_launch.py</a> based off the number.</p>
<div class="fragment"><div class="line">ls /dev/ttyUSB*</div>
</div><!-- fragment --><p>The computer may not be able to find the shared object files for CTRE Phoenix library. An easy way to fix this is to directly copy them into /usr/lib/.</p>
<div class="fragment"><div class="line">cd lunabot_ws/src/Lunabotics-2024/lunabot_autonomous/phoenix_lib/x86-64/</div>
<div class="line">sudo cp libCTRE_Phoenix.so libCTRE_PhoenixCCI.so libCTRE_PhoenixTools.so /usr/lib/</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md39"></a>
Running Robot</h1>
<p>Each launch file should be ran in a new terminal window.</p>
<p><code>Note: unplug and replug in the T265 after booting up the NUC, it will not detect it if it is not replugged in again.</code></p>
<h3><a class="anchor" id="autotoc_md40"></a>
1. Navigate to ROS 2 workspace and install (repeat on each new terminal before launches):</h3>
<div class="fragment"><div class="line">cd lunabot_ws</div>
<div class="line">source install/setup.bash</div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md41"></a>
2. Initialize SocketCAN communication (note: the canable_start.sh script will only need to be ran once each time the robot computer boots up).</h3>
<div class="fragment"><div class="line">cd lunabot_ws/src/Lunabotics-2024/</div>
<div class="line">chmod +x canable_start.sh </div>
<div class="line">./canable_start.sh</div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md42"></a>
3. Visualize with RViz2 (host computer):</h3>
<div class="fragment"><div class="line">ros2 launch lunabot_bringup external_launch.py</div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md43"></a>
4. Startup hardware:</h3>
<div class="fragment"><div class="line">ros2 launch lunabot_bringup hardware_launch.py</div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md44"></a>
5. Startup RTAB-Map:</h3>
<div class="fragment"><div class="line">ros2 launch lunabot_bringup mapping_launch.py</div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md45"></a>
6. Startup Navigation2:</h3>
<div class="fragment"><div class="line">ros2 launch lunabot_bringup navigation_launch.py</div>
</div><!-- fragment --><p>In RViz2 on the host computer, you will now be able to select a "Nav2 Goal" in the GUI and have the robot navigate to that location.</p>
<h3><a class="anchor" id="autotoc_md46"></a>
(Optional) 7. Startup action client:</h3>
<div class="fragment"><div class="line">ros2 run lunabot_autonomous navigation_client</div>
</div><!-- fragment --><p>The action client will send two goals, one for excavation zone and another for construction zone. After the goal has been reached, it will publish to /control topic and enable the specific motors for the mechanisms for the zone.</p>
<p><img src="sample.png" alt="Demo" class="inline"/></p>
<h1><a class="anchor" id="autotoc_md47"></a>
Structure</h1>
<p><b>lunabot_autonomous</b></p><ul>
<li><b>include</b><ul>
<li><b>ctre</b> (CTRE Phoenix C++ API for using Falcon 500 motors)</li>
</ul>
</li>
<li><b>phoenix_lib</b> (Contains shared object files for CTRE Phoenix C++ API)</li>
<li><b>src</b><ul>
<li><a class="el" href="hardware__monitor_8cpp.html">hardware_monitor.cpp</a> (Monitors liveliness of hardware topics)</li>
<li><a class="el" href="motor__test_8cpp.html">motor_test.cpp</a> (Simple node for testing motors)</li>
<li><a class="el" href="navigator__client_8cpp.html">navigator_client.cpp</a> (Action client that sends goals and motor control commands)</li>
<li><a class="el" href="robot__controller_8cpp.html">robot_controller.cpp</a> (Controller for both autonomous and manual control of robot)</li>
</ul>
</li>
</ul>
<p><b>lunabot_bringup</b></p><ul>
<li><b>behavior_trees</b><ul>
<li>navigate_to_pose_w_replanning_goal_patience_and_recovery.xml (Behavior tree for Navigation2)</li>
</ul>
</li>
<li><b>launch</b><ul>
<li><a class="el" href="external__launch_8py.html">external_launch.py</a> (Launches RViz2 and robot state/joint publisher nodes)</li>
<li><a class="el" href="hardware__launch_8py.html">hardware_launch.py</a> (Launches lidars, cameras, and robot controller)</li>
<li><a class="el" href="mapping__launch_8py.html">mapping_launch.py</a> (Launches RTAB-Map)</li>
<li><a class="el" href="navigation__launch_8py.html">navigation_launch.py</a> (Launches Navigation2)</li>
</ul>
</li>
<li><b>params</b><ul>
<li>default_view.rviz (RViz2 configuration file)</li>
<li>nav2_params.yaml (Parameters for Navigation2)</li>
<li>range_filter.yaml (Filter for lidar)</li>
</ul>
</li>
</ul>
<p><b>lunabot_description</b></p><ul>
<li><b>meshes</b> (Meshes for robot model in RViz2)<ul>
<li>base_link.stl</li>
<li>camera_link.stl</li>
<li>ebox_link.stl</li>
<li>lidar1_link.stl</li>
<li>lidar2_link.stl</li>
<li>nuc_link.stl</li>
<li>wheel_link.stl</li>
</ul>
</li>
<li><b>urdf</b><ul>
<li>common_properties.xacro (Defines material colors)</li>
<li>test_bot.xacro (Defines links and joints for test bot)</li>
</ul>
</li>
</ul>
<p><b>lunabot_external</b> (Packages from external sources)</p><ul>
<li>realsense_ros (Version 4.51.1)</li>
<li><a class="el" href="namespacerf2o__laser__odometry.html">rf2o_laser_odometry</a> </li>
</ul>
</div></div><!-- PageDoc -->
</div><!-- contents -->
<!-- HTML footer for doxygen 1.9.1-->
<!-- start footer part -->
</body>
</html>
